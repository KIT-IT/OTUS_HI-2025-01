---
- name: Disable swap
  command: swapoff -a
  when: ansible_swaptotal_mb | int > 0

- name: Comment swap entries in fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*\\s+swap\\s+.*)$'
    replace: '# \\1'

- name: Ensure kernel modules for kube-proxy
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Persist sysctl for Kubernetes networking
  copy:
    dest: /etc/sysctl.d/99-kubernetes-cri.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1

- name: Apply sysctl for Kubernetes networking
  command: sysctl --system
  changed_when: false

- name: Install base packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - socat
      - conntrack
    state: present
    update_cache: true

- name: Install containerd
  apt:
    name: containerd
    state: present

- name: Generate default containerd config
  command: containerd config default
  register: containerd_conf
  changed_when: false

- name: Ensure containerd config directory exists
  file:
    path: /etc/containerd
    state: directory
    mode: "0755"

- name: Configure containerd (systemd cgroup)
  copy:
    dest: /etc/containerd/config.toml
    content: "{{ containerd_conf.stdout | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true') }}"
  notify: Restart containerd

- name: Ensure apt keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Add Kubernetes apt key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes apt repository
  copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /"

- name: Install kubelet/kubeadm/kubectl
  apt:
    name:
      - "kubelet={{ k8s_version }}-1.1"
      - "kubeadm={{ k8s_version }}-1.1"
      - "kubectl={{ k8s_version }}-1.1"
    state: present
    update_cache: true

- name: Hold k8s packages
  command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false

- name: Enable and start containerd
  systemd:
    name: containerd
    state: started
    enabled: true

