# Terraform + Proxmox

Этот каталог содержит конфигурацию Terraform для развёртывания виртуальных машин в Proxmox.

## Требования

1. **Terraform** >= 1.0
2. **Proxmox VE** сервер с настроенным API токеном
3. Доступ к Proxmox веб-интерфейсу для создания API токена

## Установка Proxmox

### Вариант 1: Установка Proxmox VE на отдельном сервере (рекомендуется)

Proxmox VE обычно устанавливается на bare metal или в виртуальной машине с поддержкой виртуализации.

1. Скачайте ISO образ Proxmox VE: https://www.proxmox.com/en/downloads
2. Установите на сервер или виртуальную машину
3. Настройте сеть и доступ

### Вариант 2: Установка Proxmox в виртуальной машине (для тестирования)

Если у вас есть виртуальная машина с поддержкой вложенной виртуализации:

1. Создайте виртуальную машину (например, в VirtualBox или VMware)
2. Включите вложенную виртуализацию (nested virtualization)
3. Установите Proxmox VE ISO

### Вариант 3: Использование существующего Proxmox сервера

Если у вас уже есть доступ к Proxmox серверу, используйте его.

## Настройка Proxmox API токена

1. Войдите в веб-интерфейс Proxmox (https://your-proxmox-server:8006)
2. Перейдите в **Datacenter** → **Permissions** → **API Tokens**
3. Нажмите **Add** → **API Token**
4. Заполните:
   - **Token ID**: например, `terraform@pve!terraform-token`
   - **User**: выберите пользователя (или создайте нового)
   - **Realm**: обычно `pve`
   - **Privilege Separation**: включите для безопасности
5. Сохраните **Token Secret** (он показывается только один раз!)

## Настройка Terraform

1. Скопируйте пример файла переменных:
   ```bash
   cd terraform
   cp terraform.tfvars.example terraform.tfvars
   ```

2. Отредактируйте `terraform.tfvars` и укажите:
   - URL вашего Proxmox сервера
   - API токен ID и секрет
   - Параметры виртуальной машины
   - SSH публичный ключ

3. Если у вас есть SSH ключ, добавьте его в переменную:
   ```bash
   ssh_public_key = file("~/.ssh/id_ed25519.pub")
   ```
   Или укажите путь к файлу в `variables.tf`

## Использование

1. Инициализация Terraform:
   ```bash
   terraform init
   ```

2. Просмотр плана:
   ```bash
   terraform plan
   ```

3. Применение конфигурации:
   ```bash
   terraform apply
   ```

4. Просмотр выходных данных:
   ```bash
   terraform output
   ```

5. Удаление ресурсов:
   ```bash
   terraform destroy
   ```

## Параметры виртуальной машины

В конфигурации указаны следующие параметры ВМ:

- **Имя**: `vm_name` (по умолчанию: "terraform-vm")
- **CPU**: `vm_cpu_cores` ядер, `vm_cpu_sockets` сокетов (по умолчанию: 2 ядра, 1 сокет)
- **RAM**: `vm_memory` MB (по умолчанию: 2048 MB)
- **Диск**: `vm_disk_size` (по умолчанию: 20G)
- **Сеть**: мост `vm_network_bridge` (по умолчанию: vmbr0), модель `vm_network_model` (по умолчанию: virtio)

## Проверка создания ВМ

После выполнения `terraform apply`:

1. Проверьте вывод Terraform - там будет указан ID созданной ВМ
2. Войдите в веб-интерфейс Proxmox и проверьте наличие ВМ
3. Используйте `terraform output` для просмотра информации о ВМ

## Устранение неполадок

### Ошибка подключения к API

- Проверьте URL Proxmox сервера
- Убедитесь, что API токен создан правильно
- Проверьте, что токен имеет необходимые права доступа

### Ошибка создания ВМ

- Проверьте наличие шаблона/ISO в указанном datastore
- Убедитесь, что у пользователя есть права на создание ВМ
- Проверьте доступное место на datastore

### Проблемы с сетью

- Убедитесь, что указанный мост (vmbr0) существует
- Проверьте настройки сети в Proxmox

