---
# Роль для установки SaltGUI - веб-интерфейса для Salt

- name: Install prerequisites
  apt:
    name:
      - git
      - python3-pip
      - python3-dev
    state: present
    update_cache: yes

- name: Install Salt API (cherrypy)
  pip:
    name:
      - cherrypy
      - ws4py
    state: present
    executable: pip3

- name: Create SaltGUI directory
  file:
    path: /opt/saltgui
    state: directory
    mode: '0755'

- name: Clone SaltGUI repository
  git:
    repo: https://github.com/erwindon/SaltGUI.git
    dest: /opt/saltgui
    version: master
    force: yes

- name: Check if REST API is already configured
  command: grep -q "rest_cherrypy:" /etc/salt/master
  register: rest_api_configured
  changed_when: false
  failed_when: false

- name: Configure Salt Master for REST API
  blockinfile:
    path: /etc/salt/master
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Salt REST API"
    block: |
      # REST API для SaltGUI
      rest_cherrypy:
        port: 8000
        host: 0.0.0.0
        disable_ssl: true
        webhook_url: /hook
  when: not rest_api_configured.rc
  notify: restart salt-master

- name: Create SaltGUI systemd service
  template:
    src: saltgui.service.j2
    dest: /etc/systemd/system/saltgui.service
    mode: '0644'
  notify: restart saltgui

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Create Salt API systemd service
  template:
    src: salt-api.service.j2
    dest: /etc/systemd/system/salt-api.service
    mode: '0644'
  notify: restart salt-api

- name: Reload systemd daemon (for salt-api)
  systemd:
    daemon_reload: yes

- name: Ensure Salt API service is running and enabled
  systemd:
    name: salt-api
    state: started
    enabled: yes

- name: Ensure SaltGUI service is running and enabled
  systemd:
    name: saltgui
    state: started
    enabled: yes

- name: Check SaltGUI status
  command: systemctl status saltgui
  register: saltgui_status
  changed_when: false
  failed_when: false

- name: Check Salt API status
  command: systemctl status salt-api
  register: salt_api_status
  changed_when: false
  failed_when: false

- name: Display SaltGUI status
  debug:
    msg: "{{ saltgui_status.stdout_lines }}"

- name: Display Salt API status
  debug:
    msg: "{{ salt_api_status.stdout_lines }}"

