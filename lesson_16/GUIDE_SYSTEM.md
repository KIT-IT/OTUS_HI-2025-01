# Гайд по системе - Архитектура и принципы работы

Этот документ описывает архитектуру системы сбора и анализа логов через Kafka и ELK стек.

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         APP Node                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────────┐    │
│  │  nginx   │  │ WordPress │  │      Fluent Bit          │    │
│  │          │  │           │  │                          │    │
│  │ access.log│ │ app.log   │  │  ┌────────────────────┐ │    │
│  │ error.log │ │           │  │  │ File Inputs:       │ │    │
│  └────┬─────┘  └─────┬────┘  │  │ - nginx/access.log │ │    │
│       │              │        │  │ - nginx/error.log  │ │    │
│       └──────┬───────┘        │  │ - wordpress/*.log  │ │    │
│              │                 │  └──────────┬─────────┘ │    │
│              │                 │             │           │    │
│              └─────────────────┴─────────────┘           │    │
│                                                           │    │
│                          │                                │    │
└──────────────────────────┼────────────────────────────────┘    │
                           │                                      │
                           │ Kafka Producer                       │
                           │                                       │
                           ▼                                       │
┌─────────────────────────────────────────────────────────────────┐
│                        Kafka Node                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Kafka Cluster (KRaft mode)                   │  │
│  │                                                            │  │
│  │  ┌──────────────┐         ┌──────────────┐               │  │
│  │  │  Broker 1    │         │  Broker 2    │               │  │
│  │  │  Port: 9092  │◄───────►│  Port: 9093  │               │  │
│  │  │              │         │              │               │  │
│  │  │ Node ID: 1   │         │  Node ID: 2  │               │  │
│  │  └──────────────┘         └──────────────┘               │  │
│  │                                                            │  │
│  │  Topics:                                                   │  │
│  │  ┌─────────────────────────────────────────────┐         │  │
│  │  │ Topic: nginx                                 │         │  │
│  │  │ - Partitions: 2                               │         │  │
│  │  │ - Replication Factor: 2                       │         │  │
│  │  │ - Partition 0: Leader=1, Replicas=[1,2]       │         │  │
│  │  │ - Partition 1: Leader=2, Replicas=[2,1]       │         │  │
│  │  └─────────────────────────────────────────────┘         │  │
│  │  ┌─────────────────────────────────────────────┐         │  │
│  │  │ Topic: wordpress                              │         │  │
│  │  │ - Partitions: 2                               │         │  │
│  │  │ - Replication Factor: 2                       │         │  │
│  │  │ - Partition 0: Leader=2, Replicas=[2,1]       │         │  │
│  │  │ - Partition 1: Leader=1, Replicas=[1,2]       │         │  │
│  │  └─────────────────────────────────────────────┘         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                          │                                      │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           │ Kafka Consumer
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                         ELK Node                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Logstash                             │  │
│  │  ┌────────────────────────────────────────────────────┐ │  │
│  │  │ Input: Kafka                                        │ │  │
│  │  │ - Bootstrap: kafka:9092,kafka:9093                  │ │  │
│  │  │ - Topics: nginx, wordpress                          │ │  │
│  │  │ - Group ID: logstash                                │ │  │
│  │  └─────────────────┬──────────────────────────────────┘ │  │
│  │                    │ Filter                              │  │
│  │  ┌─────────────────▼──────────────────────────────────┐ │  │
│  │  │ - Add source_type field                            │ │  │
│  │  │ - Parse nginx logs                                 │ │  │
│  │  │ - Create index name: nginx-YYYY.MM.DD              │ │  │
│  │  └─────────────────┬──────────────────────────────────┘ │  │
│  │                    │ Output                             │  │
│  │  ┌─────────────────▼──────────────────────────────────┐ │  │
│  │  │ OpenSearch Output                                   │ │  │
│  │  │ - Host: opensearch:9200                            │ │  │
│  │  │ - Index: nginx-YYYY.MM.DD                          │ │  │
│  │  └────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                          │                                      │
│  ┌────────────────────────▼─────────────────────────────────┐  │
│  │                  OpenSearch                              │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ Indices:                                           │  │  │
│  │  │ - nginx-2025.11.04                                 │  │  │
│  │  │ - wordpress-2025.11.04                             │  │  │
│  │  │                                                     │  │  │
│  │  │ Documents:                                          │  │  │
│  │  │ - Log entries with @timestamp, source_type, etc.  │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └────────────────────────┬─────────────────────────────────┘  │
│                          │                                      │
│  ┌────────────────────────▼─────────────────────────────────┐  │
│  │            OpenSearch Dashboards                         │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │ Web UI: http://<elk_ip>:5601                       │  │  │
│  │  │                                                     │  │  │
│  │  │ Index Patterns:                                     │  │  │
│  │  │ - nginx-*                                           │  │  │
│  │  │ - wordpress-*                                       │  │  │
│  │  │                                                     │  │  │
│  │  │ Features:                                           │  │  │
│  │  │ - Discover (просмотр логов)                        │  │  │
│  │  │ - Visualize (графики и дашборды)                   │  │  │
│  │  │ - Dashboard (сводные панели)                       │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. APP Node (Узел приложений)

**Назначение:** Генерация логов и их отправка в Kafka

**Компоненты:**
- **Nginx** - веб-сервер, генерирует access.log и error.log
- **WordPress** - приложение (placeholder), генерирует логи в /var/log/wordpress/
- **Fluent Bit** - агент сбора логов

**Функции Fluent Bit:**
- Чтение логов из файлов:
  - `/var/log/nginx/access.log`
  - `/var/log/nginx/error.log`
  - `/var/log/wordpress/*.log`
- Добавление метаданных (source_type)
- Отправка в Kafka топики:
  - `nginx` → топик nginx
  - `wordpress` → топик wordpress

**Конфигурация:** `/etc/fluent-bit/fluent-bit.conf`

### 2. Kafka Node (Брокер сообщений)

**Назначение:** Буферизация и распределение логов

**Компоненты:**
- **Kafka Broker 1** - порт 9092, Node ID: 1
- **Kafka Broker 2** - порт 9093, Node ID: 2

**Режим работы:** KRaft (Kafka Raft) - без Zookeeper

**Топики:**
1. **nginx**
   - Партиций: 2
   - Репликация: 2 (обе партиции реплицируются на оба брокера)
   - Назначение: логи nginx (access + error)

2. **wordpress**
   - Партиций: 2
   - Репликация: 2
   - Назначение: логи WordPress

**Преимущества:**
- Отказоустойчивость (репликация)
- Масштабируемость (партиции)
- Буферизация (логи не теряются при сбое ELK)

**Конфигурация:** Docker Compose в `/opt/kafka/docker-compose.yml`

### 3. ELK Node (Анализ и визуализация)

**Назначение:** Индексация, обработка и визуализация логов

**Компоненты:**

#### 3.1. Logstash

**Функции:**
- **Input:** Чтение из Kafka топиков nginx и wordpress
- **Filter:** 
  - Определение типа источника (source_type)
  - Парсинг структурированных логов
  - Формирование имени индекса (nginx-YYYY.MM.DD)
- **Output:** Запись в OpenSearch

**Конфигурация:** `/opt/elk/logstash/pipeline/logstash.conf`

#### 3.2. OpenSearch

**Функции:**
- Хранение индексированных логов
- Поиск по логам
- Агрегация данных

**Индексы:**
- Формат: `nginx-YYYY.MM.DD`, `wordpress-YYYY.MM.DD`
- Создаются автоматически при появлении первых логов за день
- Time field: `@timestamp`

**Доступ:** HTTP API на порту 9200

#### 3.3. OpenSearch Dashboards

**Функции:**
- Веб-интерфейс для просмотра логов
- Создание визуализаций
- Дашборды

**Доступ:** HTTP на порту 5601

**Index Patterns:**
- `nginx-*` - для всех логов nginx
- `wordpress-*` - для всех логов wordpress

## Поток данных

### 1. Генерация логов

```
Пользователь → Nginx → access.log / error.log
WordPress → /var/log/wordpress/app.log
```

### 2. Сбор логов (Fluent Bit)

```
Fluent Bit читает файлы:
  - tail input plugin читает /var/log/nginx/access.log
  - tail input plugin читает /var/log/nginx/error.log
  - tail input plugin читает /var/log/wordpress/*.log

Fluent Bit добавляет метаданные:
  - source_type: "nginx" или "wordpress"
  - @timestamp (автоматически)

Fluent Bit отправляет в Kafka:
  - nginx логи → топик "nginx"
  - wordpress логи → топик "wordpress"
```

### 3. Буферизация (Kafka)

```
Сообщения записываются в топики:
  - Распределение по партициям (round-robin)
  - Репликация на оба брокера
  - Хранение до прочтения Logstash
```

### 4. Обработка (Logstash)

```
Logstash читает из Kafka:
  - Consumer group: "logstash"
  - Topics: nginx, wordpress

Logstash фильтрует:
  - Определяет source_type
  - Создает имя индекса: nginx-2025.11.04

Logstash записывает в OpenSearch:
  - Index: nginx-2025.11.04
  - Document: { "@timestamp": "...", "source_type": "nginx", ... }
```

### 5. Индексация (OpenSearch)

```
OpenSearch:
  - Принимает документы от Logstash
  - Индексирует по @timestamp
  - Хранит в индексе nginx-YYYY.MM.DD
```

### 6. Визуализация (Dashboards)

```
Пользователь открывает Dashboards:
  - Выбирает index pattern: nginx-*
  - Просматривает логи в Discover
  - Создает визуализации и дашборды
```

## Преимущества архитектуры

### 1. Отказоустойчивость

- **Kafka:** Репликация на 2 брокера - если один упадет, данные доступны со второго
- **ELK:** Логи буферизируются в Kafka, если ELK недоступен

### 2. Масштабируемость

- **Kafka:** Партиции позволяют распределить нагрузку
- **Logstash:** Можно добавить несколько инстансов для обработки
- **OpenSearch:** Можно масштабировать кластер

### 3. Производительность

- **Kafka:** Буферизация снижает нагрузку на ELK
- **Партиции:** Параллельная обработка
- **Индексы по дням:** Быстрый поиск по датам

### 4. Гибкость

- Легко добавить новые источники логов
- Легко изменить обработку в Logstash
- Легко создать новые визуализации

## Технические детали

### Kafka KRaft режим

Традиционно Kafka использует Zookeeper для управления метаданными. В KRaft режиме:
- Kafka сама управляет метаданными через Raft консенсус
- Меньше компонентов (нет Zookeeper)
- Быстрее запуск и переключение лидеров

### Партиции и репликация

**Партиция** - единица параллелизма:
- Каждая партиция обрабатывается независимо
- Сообщения в одной партиции сохраняют порядок
- 2 партиции = возможность параллельной обработки 2 потребителями

**Репликация:**
- Каждая партиция реплицируется на 2 брокера
- Один брокер - лидер, второй - реплика
- При падении лидера реплика становится лидером

### Index Patterns в Dashboards

**Index Pattern** - шаблон для поиска по индексам:
- `nginx-*` соответствует: nginx-2025.11.04, nginx-2025.11.05, и т.д.
- Позволяет просматривать логи за все дни одним паттерном
- Time field (`@timestamp`) используется для фильтрации по времени

## Мониторинг и метрики

### Ключевые метрики для мониторинга:

1. **Kafka:**
   - Lag потребителей (отставание Logstash от producer)
   - Размер топиков
   - Throughput (сообщений/сек)

2. **Fluent Bit:**
   - Количество обработанных записей
   - Ошибки отправки в Kafka

3. **Logstash:**
   - Throughput обработки
   - Ошибки парсинга
   - Lag от Kafka

4. **OpenSearch:**
   - Размер индексов
   - Количество документов
   - Время поиска

5. **Dashboards:**
   - Время ответа
   - Доступность

## Следующие шаги

1. Изучите [GUIDE_CHECK.md](GUIDE_CHECK.md) для проверки работы системы
2. Настройте алерты на критичные метрики
3. Создайте дашборды для мониторинга
4. Настройте retention политики для индексов

