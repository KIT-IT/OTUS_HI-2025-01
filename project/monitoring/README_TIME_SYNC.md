# Скрипт синхронизации времени

## Описание

Скрипт `sync_time.sh` предназначен для синхронизации времени на всех нодах кластера:
- Хост (Proxmox)
- Все LXC контейнеры (CT 100-111)

## Использование

```bash
# Запуск синхронизации
/root/monitoring/sync_time.sh

# Или из директории monitoring
cd /root/monitoring
./sync_time.sh
```

## Что делает скрипт

1. **Синхронизация хоста:**
   - Проверяет наличие chronyd/chrony/ntpdate
   - Выполняет принудительную синхронизацию с NTP серверами
   - Проверяет статус синхронизации

2. **Синхронизация контейнеров:**
   - Проверяет доступность каждого контейнера
   - Пытается синхронизировать через chronyd (если доступен)
   - Использует ntpdate как альтернативу
   - Для LXC контейнеров отмечает, что они используют время хоста

3. **Проверка статуса:**
   - Сравнивает время всех контейнеров с хостом
   - Выводит статистику синхронизации
   - Показывает максимальное расхождение

4. **Отчет:**
   - Выводит итоговый отчет о синхронизации
   - Показывает текущее время (UTC)
   - Предоставляет рекомендации

## Автоматический запуск

Для автоматической синхронизации можно добавить в cron:

```bash
# Синхронизация каждый час
0 * * * * /root/monitoring/sync_time.sh >> /var/log/time_sync.log 2>&1

# Синхронизация при загрузке системы
@reboot /root/monitoring/sync_time.sh >> /var/log/time_sync.log 2>&1
```

## Важные замечания

1. **LXC контейнеры:**
   - Не могут запускать chronyd из-за ограничений безопасности
   - Автоматически используют время хоста
   - Это нормальное поведение

2. **Точность синхронизации:**
   - Разница < 5 секунд - отлично ✅
   - Разница 5-30 секунд - приемлемо ⚠️
   - Разница > 30 секунд - требует внимания ❌

3. **NTP серверы:**
   - Используется pool.ntp.org
   - На хосте может быть настроен time.cloudflare.com

## Проверка синхронизации вручную

```bash
# Статус NTP на хосте
chronyc tracking
chronyc sources

# Время на хосте (UTC)
date -u

# Время на контейнере (UTC)
pct exec <CT_ID> -- date -u

# Сравнение времени
host_time=$(date -u '+%s')
ct_time=$(pct exec <CT_ID> -- date -u '+%s')
diff=$((ct_time - host_time))
echo "Разница: ${diff} секунд"
```

## Логи

Скрипт выводит информацию в stdout. Для сохранения логов:

```bash
/root/monitoring/sync_time.sh | tee /var/log/time_sync_$(date +%Y%m%d_%H%M%S).log
```

## Устранение проблем

### chronyd не запускается в контейнере
- Это нормально для LXC контейнеров
- Контейнеры используют время хоста автоматически

### Большое расхождение времени
1. Проверьте синхронизацию хоста: `chronyc tracking`
2. Перезапустите chronyd на хосте: `systemctl restart chronyd`
3. Выполните принудительную синхронизацию: `chronyc makestep`

### Контейнер недоступен
- Проверьте статус контейнера: `pct status <CT_ID>`
- Убедитесь, что контейнер запущен: `pct start <CT_ID>`


