global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /var/lib/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Статистика HAProxy
listen stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}

# PostgreSQL кластер
frontend postgresql_frontend
    bind *:{{ haproxy_listen_port }}
    default_backend postgresql_backend

backend postgresql_backend
    balance roundrobin
    option httpchk GET /master
    http-check expect status 200
{% for host in groups['postgresql'] %}
    server {{ hostvars[host]['patroni_name'] }} {{ hostvars[host]['ct_ip'] }}:5432 check port 8008 inter 3s fall 3 rise 3
{% endfor %}

# Docker Swarm Manager кластер
frontend docker_swarm_frontend
    bind *:{{ docker_swarm_port }}
    default_backend docker_swarm_backend

backend docker_swarm_backend
    balance roundrobin
    mode tcp
    option tcplog
{% for host in groups['docker_swarm'] %}
    server {{ host }} {{ hostvars[host]['ct_ip'] }}:{{ docker_swarm_port }} check inter 3s fall 3 rise 3
{% endfor %}

# AM HTTPS (через Docker Swarm Managers -> AM service)
# Один frontend балансирует на разные менеджеры с разными портами
frontend am_https_frontend
    bind *:{{ am_https_port }} ssl crt /etc/haproxy/{{ am_cert_pem }}
    mode http
    option httplog
    option http-buffer-request
    default_backend am_https_backend

backend am_https_backend
    mode http
    balance roundrobin
    option httpchk GET /am/health
    server docker_mgr1_am {{ hostvars['docker_mgr1']['ct_ip'] }}:{{ am_backend_port_mgr1 }} ssl verify none check
    server docker_mgr2_am {{ hostvars['docker_mgr2']['ct_ip'] }}:{{ am_backend_port_mgr2 }} ssl verify none check


