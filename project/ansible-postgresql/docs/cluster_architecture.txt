╔══════════════════════════════════════════════════════════════════════════════╗
║                  PostgreSQL HA Cluster Architecture                          ║
║                    Patroni + etcd + HAProxy                                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

                    ┌─────────────────────────────────┐
                    │        Клиенты                   │
                    │   (Приложения, пользователи)     │
                    └────────────┬──────────────────────┘
                                 │
                                 │
                    ┌─────────────────────────────────┐
                    │        VIP_HAProxy              │
                    │     
                    └────────────┬──────────────────────┘
                    │                         │
            ┌───────▼────────┐      ┌─────────▼────────┐
            │   HAProxy 1    │      │   HAProxy 2      │
            │ 192.168.50.11  │      │ 192.168.50.12    │
            │    CT 100      │      │    CT 101        │
            │  Порт: 5432    │      │  Порт: 5432      │
            └───────┬────────┘      └─────────┬────────┘
                    │                         │
                    │  Health Check (8008)    │
                    │  PostgreSQL (5432)      │
                    │                         │
        ┌───────────┴─────────────────────────┴───────────┐
        │                                                  │
        │         PostgreSQL + Patroni Cluster             │
        │                                                  │
        │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │  │   pg102      │  │   pg103      │  │   pg104      │
        │  │  replica     │  │  master      │  │  replica     │
        │  │ 50.21:5432   │  │ 50.22:5432   │  │ 50.23:5432   │
        │  │ 50.21:8008   │  │ 50.22:8008   │  │ 50.23:8008   │
        │  │   CT 102     │  │   CT 103     │  │   CT 104     │
        │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
        │         │                 │                 │
        │         └─────────┬───────┴─────────┬────────┘
        │                   │                 │
        │         Streaming Replication      │
        │         (WAL поток)                │
        │                                   │
        └───────────────────┬───────────────┘
                            │
                            │ Координация через etcd
                            │
        ┌───────────────────┴───────────────────┐
        │                                         │
        │            etcd Cluster                 │
        │                                         │
        │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │  │    etcd1     │  │    etcd2     │  │    etcd3     │
        │  │  50.51:2379 │  │  50.52:2379  │  │  50.53:2379  │
        │  │  50.51:2380 │  │  50.52:2380  │  │  50.53:2380  │
        │  │   CT 109    │  │   CT 110     │  │   CT 111     │
        │  └──────┬──────┘  └──────┬──────┘  └──────┬───────┘
        │         │                 │                 │
        │         └─────────┬───────┴─────────┬───────┘
        │                   │                 │
        │         Кластер etcd                │
        │    (Raft консенсус)                │
        │                                     │
        └─────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════

Потоки данных:

1. Клиент → HAProxy → PostgreSQL
   └─> Запросы к базе данных

2. PostgreSQL Master → PostgreSQL Replicas
   └─> Streaming Replication (WAL)

3. Patroni ↔ etcd
   └─> Координация, выбор лидера, хранение состояния

4. HAProxy → Patroni REST API
   └─> Health checks для определения доступных узлов

═══════════════════════════════════════════════════════════════════════════════

Порядок запуска:

1. etcd (CT 109, 110, 111)        - Координация
2. Patroni (CT 102, 103, 104)     - Управление HA
3. PostgreSQL (запускается Patroni) - База данных
4. HAProxy (CT 100, 101)           - Балансировка

═══════════════════════════════════════════════════════════════════════════════
